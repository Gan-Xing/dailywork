// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum PhaseMeasure {
  LINEAR
  POINT
}

enum InspectionStatus {
  PENDING
  SCHEDULED
  SUBMITTED
  IN_PROGRESS
  APPROVED
}

enum IntervalSide {
  BOTH
  LEFT
  RIGHT
}

enum EmploymentStatus {
  ACTIVE
  TERMINATED
  ON_LEAVE
}

enum PermissionStatus {
  ACTIVE
  ARCHIVED
}

enum RoadmapStatus {
  PENDING
  DONE
}

enum DocumentType {
  SUBMISSION
  LETTER
  MINUTES
  SUPPLY_REQUEST
}

enum TemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum DocumentStatus {
  DRAFT
  FINAL
  ARCHIVED
}

model PhaseDefinition {
  id             Int                     @id @default(autoincrement())
  name           String
  measure        PhaseMeasure
  unitPrice      Decimal?                @db.Decimal(18, 2)
  pointHasSides  Boolean                 @default(false)
  isActive       Boolean                 @default(true)
  defaultLayers  PhaseDefinitionLayer[]
  defaultChecks  PhaseDefinitionCheck[]
  phases         RoadPhase[]
  priceItems     PhasePriceItem[]
  workflows      PhaseWorkflowDefinition[]
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  @@unique([name, measure])
}

model LayerDefinition {
  id               Int                     @id @default(autoincrement())
  name             String                  @unique
  isActive         Boolean                 @default(true)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  definitionLinks  PhaseDefinitionLayer[]
  phaseLinks       RoadPhaseLayer[]
}

model CheckDefinition {
  id               Int                     @id @default(autoincrement())
  name             String                  @unique
  isActive         Boolean                 @default(true)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  definitionLinks  PhaseDefinitionCheck[]
  phaseLinks       RoadPhaseCheck[]
}

model PhaseDefinitionLayer {
  phaseDefinitionId Int
  layerDefinitionId Int
  phaseDefinition   PhaseDefinition @relation(fields: [phaseDefinitionId], references: [id], onDelete: Cascade)
  layerDefinition   LayerDefinition @relation(fields: [layerDefinitionId], references: [id], onDelete: Cascade)

  @@id([phaseDefinitionId, layerDefinitionId])
}

model PhaseDefinitionCheck {
  phaseDefinitionId Int
  checkDefinitionId Int
  phaseDefinition   PhaseDefinition @relation(fields: [phaseDefinitionId], references: [id], onDelete: Cascade)
  checkDefinition   CheckDefinition @relation(fields: [checkDefinitionId], references: [id], onDelete: Cascade)

  @@id([phaseDefinitionId, checkDefinitionId])
}

model PhaseWorkflowDefinition {
  id                Int             @id @default(autoincrement())
  phaseDefinitionId Int             @unique
  phaseDefinition   PhaseDefinition @relation(fields: [phaseDefinitionId], references: [id], onDelete: Cascade)
  config            Json
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model DailyReport {
  id         Int      @id @default(autoincrement())
  reportDate DateTime @unique
  payload    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model RoadSection {
  id        Int      @id @default(autoincrement())
  slug      String   @unique
  name      String
  startPk   String
  endPk     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  phases    RoadPhase[]
  inspections InspectionRequest[]
  inspectionEntries InspectionEntry[]
}

model RoadPhase {
  id                Int                 @id @default(autoincrement())
  roadId            Int
  road              RoadSection         @relation(fields: [roadId], references: [id], onDelete: Cascade)
  phaseDefinitionId Int
  phaseDefinition   PhaseDefinition     @relation(fields: [phaseDefinitionId], references: [id])
  name              String
  measure           PhaseMeasure
  pointHasSides     Boolean             @default(false)
  designLength      Float               @default(0)
  intervals         PhaseInterval[]
  inspections       InspectionRequest[]
  entries           InspectionEntry[]
  layerLinks        RoadPhaseLayer[]
  checkLinks        RoadPhaseCheck[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model PhasePriceItem {
  id                Int             @id @default(autoincrement())
  phaseDefinitionId Int
  phaseDefinition   PhaseDefinition @relation(fields: [phaseDefinitionId], references: [id], onDelete: Cascade)
  name              String
  spec              String?
  measure           PhaseMeasure
  unitString        String?
  description       String?
  unitPrice         Decimal?        @db.Decimal(18, 2)
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model PhaseInterval {
  id        Int           @id @default(autoincrement())
  phaseId   Int
  phase     RoadPhase     @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  startPk   Float
  endPk     Float
  side      IntervalSide
  spec      String?
  layers    String[]      @default([])
  layerIds  Int[]         @default([])
  billQuantity Float?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model InspectionRequest {
  id         Int              @id @default(autoincrement())
  roadId     Int
  road       RoadSection      @relation(fields: [roadId], references: [id], onDelete: Cascade)
  phaseId    Int
  phase      RoadPhase        @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  side       IntervalSide
  startPk    Float
  endPk      Float
  layers     String[]
  checks     String[]
  types      String[]
  submissionOrder Int?
  remark     String?
  status     InspectionStatus @default(PENDING)
  appointmentDate DateTime?
  submittedAt     DateTime     @default(now())
  submittedBy     Int?
  submitter       User?        @relation("InspectionSubmitter", fields: [submittedBy], references: [id])
  createdBy       Int?
  creator         User?        @relation("InspectionCreator", fields: [createdBy], references: [id])
  updatedBy       Int?
  updater         User?        @relation("InspectionUpdater", fields: [updatedBy], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([phaseId, status, updatedAt])
}

model Document {
  id              Int                @id @default(autoincrement())
  code            String             @unique
  files           Json               @default("[]")
  remark          String?
  type            DocumentType       @default(SUBMISSION)
  templateId      String?
  template        DocumentTemplate? @relation(fields: [templateId], references: [id])
  templateVersion Int?
  status          DocumentStatus     @default(DRAFT)
  title           String?
  data            Json?
  createdById     Int?
  updatedById     Int?
  createdBy       User?              @relation("DocumentCreator", fields: [createdById], references: [id])
  updatedBy       User?              @relation("DocumentUpdater", fields: [updatedById], references: [id])
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  entries         InspectionEntry[]
  submission      Submission?
  items           SubmissionItem[]

  @@index([type, status])
  @@index([createdAt])
  @@index([updatedAt])
}

model InspectionEntry {
  id           Int              @id @default(autoincrement())
  documentId   Int?
  document     Document?        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  roadId       Int
  road         RoadSection      @relation(fields: [roadId], references: [id], onDelete: Cascade)
  phaseId      Int
  phase        RoadPhase        @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  side         IntervalSide
  startPk      Float
  endPk        Float
  layerId      Int?
  layerName    String
  checkId      Int?
  checkName    String
  types        String[]
  status       InspectionStatus @default(PENDING)
  appointmentDate DateTime?
  remark       String?
  submissionOrder Int?
  submittedAt  DateTime         @default(now())
  submittedBy  Int?
  submitter    User?            @relation("InspectionEntrySubmitter", fields: [submittedBy], references: [id])
  createdBy    Int?
  creator      User?            @relation("InspectionEntryCreator", fields: [createdBy], references: [id])
  updatedBy    Int?
  updater      User?            @relation("InspectionEntryUpdater", fields: [updatedBy], references: [id])
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([roadId, phaseId, side, startPk, endPk, status])
  @@index([documentId])
}

model Submission {
  documentId         Int    @id
  submissionNumber   Int    @unique
  projectName        String
  projectCode        String
  contractNumbers    Json
  bordereauNumber    Int
  subject            String
  senderOrg          String
  senderDate         String
  senderLastName     String
  senderFirstName    String
  senderSignature    String?
  senderTime         String?
  recipientOrg       String
  recipientDate      String
  recipientLastName  String
  recipientFirstName String
  recipientSignature String?
  recipientTime      String?
  comments           String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

model SubmissionItem {
  id          Int      @id @default(autoincrement())
  documentId  Int
  order       Int?
  designation String
  quantity    Float?
  observation String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId, order])
}

model RoadPhaseLayer {
  roadPhaseId       Int
  layerDefinitionId Int
  roadPhase         RoadPhase     @relation(fields: [roadPhaseId], references: [id], onDelete: Cascade)
  layerDefinition   LayerDefinition @relation(fields: [layerDefinitionId], references: [id], onDelete: Cascade)

  @@id([roadPhaseId, layerDefinitionId])
}

model RoadPhaseCheck {
  roadPhaseId       Int
  checkDefinitionId Int
  roadPhase         RoadPhase      @relation(fields: [roadPhaseId], references: [id], onDelete: Cascade)
  checkDefinition   CheckDefinition @relation(fields: [checkDefinitionId], references: [id], onDelete: Cascade)

  @@id([roadPhaseId, checkDefinitionId])
}

model Permission {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  status    PermissionStatus @default(ACTIVE)
  roles     RolePermission[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id           Int              @id @default(autoincrement())
  name         String           @unique
  permissions  RolePermission[]
  users        UserRole[]
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

model User {
  id           Int        @id @default(autoincrement())
  name         String     @default("")
  gender       String?
  nationality  String?
  phones       String[]   @default([])
  joinDate     DateTime?
  position     String?
  employmentStatus EmploymentStatus @default(ACTIVE)
  terminationDate DateTime?
  terminationReason String?
  username     String     @unique
  passwordHash String
  roles        UserRole[]
  submittedInspections InspectionRequest[] @relation("InspectionSubmitter")
  createdInspections  InspectionRequest[] @relation("InspectionCreator")
  updatedInspections  InspectionRequest[] @relation("InspectionUpdater")
  submittedInspectionEntries InspectionEntry[] @relation("InspectionEntrySubmitter")
  createdInspectionEntries  InspectionEntry[] @relation("InspectionEntryCreator")
  updatedInspectionEntries  InspectionEntry[] @relation("InspectionEntryUpdater")
  createdFinances FinanceEntry[] @relation("FinanceEntryCreator")
  deletedFinances FinanceEntry[] @relation("FinanceEntryDeleter")
  handledFinances FinanceEntry[] @relation("FinanceEntryHandler")
  updatedFinances FinanceEntry[] @relation("FinanceEntryUpdater")
  chineseProfile UserChineseProfile?
  expatProfile UserExpatProfile?
  createdById  Int?
  updatedById  Int?
  createdBy    User?      @relation("UserCreator", fields: [createdById], references: [id])
  updatedBy    User?      @relation("UserUpdater", fields: [updatedById], references: [id])
  createdUsers User[]     @relation("UserCreator")
  updatedUsers User[]     @relation("UserUpdater")
  roadmapIdeasCreated RoadmapIdea[] @relation("RoadmapIdeaCreator")
  roadmapIdeasUpdated RoadmapIdea[] @relation("RoadmapIdeaUpdater")
  createdDocumentTemplates DocumentTemplate[] @relation("DocumentTemplateCreator")
  updatedDocumentTemplates DocumentTemplate[] @relation("DocumentTemplateUpdater")
  createdDocuments Document[] @relation("DocumentCreator")
  updatedDocuments Document[] @relation("DocumentUpdater")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId Int
  roleId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model UserChineseProfile {
  userId                 Int     @id
  user                   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  frenchName             String?
  idNumber               String?
  passportNumber         String?
  educationAndMajor      String?
  certifications         String[] @default([])
  domesticMobile         String?
  emergencyContactName   String?
  emergencyContactPhone  String?
  redBookValidYears      Int?    @default(0)
  cumulativeAbroadYears  Int?    @default(0)
  birthplace             String?
  residenceInChina       String?
  medicalHistory         String?
  healthStatus           String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model UserExpatProfile {
  userId    Int     @id
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  code      String?   @unique
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  finances  FinanceEntry[]
}

model FinanceUnit {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  symbol    String?
  isActive  Boolean   @default(true)
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  finances  FinanceEntry[]
}

model PaymentType {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  isActive  Boolean   @default(true)
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  finances  FinanceEntry[]
}

model FinanceCategory {
  key       String   @id
  parentKey String?
  labelZh   String
  labelEn   String?
  labelFr   String?
  code      String?
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  children  FinanceCategory[] @relation("FinanceCategoryToFinanceCategory")
  parent    FinanceCategory?  @relation("FinanceCategoryToFinanceCategory", fields: [parentKey], references: [key])
  finances  FinanceEntry[]
}

model FinanceEntry {
  id            Int            @id @default(autoincrement())
  sequence      Int            @default(autoincrement())
  projectId     Int
  reason        String
  categoryKey   String
  parentKeys    String[]       @default([])
  amount        Decimal        @db.Decimal(18, 2)
  unitId        Int
  paymentTypeId Int
  paymentDate   DateTime
  tva           Decimal?       @db.Decimal(18, 2)
  remark        String?
  handlerId     Int?
  isDeleted     Boolean        @default(false)
  deletedAt     DateTime?
  deletedBy     Int?
  updatedBy     Int?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     Int?
  project       Project        @relation(fields: [projectId], references: [id])
  category      FinanceCategory @relation(fields: [categoryKey], references: [key])
  unit          FinanceUnit    @relation(fields: [unitId], references: [id])
  paymentType   PaymentType    @relation(fields: [paymentTypeId], references: [id])
  creator       User?          @relation("FinanceEntryCreator", fields: [createdBy], references: [id])
  updater       User?          @relation("FinanceEntryUpdater", fields: [updatedBy], references: [id])
  deleter       User?          @relation("FinanceEntryDeleter", fields: [deletedBy], references: [id])
  handler       User?          @relation("FinanceEntryHandler", fields: [handlerId], references: [id])

  @@unique([sequence])
  @@index([projectId])
  @@index([categoryKey])
  @@index([paymentDate])
  @@index([isDeleted])
  @@index([handlerId])
}

model DocumentTemplate {
  id           String         @id @default(cuid())
  name         String
  type         DocumentType   @default(SUBMISSION)
  version      Int            @default(1)
  status       TemplateStatus @default(DRAFT)
  language     String         @default("fr")
  html         String         @db.Text
  placeholders Json
  createdById  Int?
  updatedById  Int?
  createdBy    User?          @relation("DocumentTemplateCreator", fields: [createdById], references: [id])
  updatedBy    User?          @relation("DocumentTemplateUpdater", fields: [updatedById], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  documents    Document[]

  @@index([type, status])
  @@index([name])
}

model RoadmapIdea {
  id           Int            @id @default(autoincrement())
  title        String
  details      String?
  priority     Int            @default(3)
  importance   Int            @default(3)
  difficulty   Int            @default(3)
  status       RoadmapStatus  @default(PENDING)
  completedAt  DateTime?
  createdById  Int?
  updatedById  Int?
  createdBy    User?          @relation("RoadmapIdeaCreator", fields: [createdById], references: [id])
  updatedBy    User?          @relation("RoadmapIdeaUpdater", fields: [updatedById], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([status, createdAt])
}
