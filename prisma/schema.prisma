// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum PhaseMeasure {
  LINEAR
  POINT
}

enum InspectionStatus {
  PENDING
  SCHEDULED
  SUBMITTED
  IN_PROGRESS
  APPROVED
}

enum IntervalSide {
  BOTH
  LEFT
  RIGHT
}

enum EmploymentStatus {
  ACTIVE
  TERMINATED
  ON_LEAVE
}

enum ContractType {
  CTJ
  CDD
}

enum SalaryUnit {
  MONTH
  HOUR
}

enum PermissionStatus {
  ACTIVE
  ARCHIVED
}

enum RoadmapStatus {
  PENDING
  DONE
}

enum DocumentType {
  SUBMISSION
  LETTER
  MINUTES
  SUPPLY_REQUEST
  DAILY_REPORT
}

enum TemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum DocumentStatus {
  DRAFT
  FINAL
  ARCHIVED
}

enum PaymentStatus {
  PENDING
  PAID
}

enum BoqSheetType {
  CONTRACT
  ACTUAL
}

enum BoqItemTone {
  SECTION
  SUBSECTION
  ITEM
  TOTAL
}

model PhaseDefinition {
  id             Int                     @id @default(autoincrement())
  name           String
  measure        PhaseMeasure
  unitPrice      Decimal?                @db.Decimal(18, 2)
  pointHasSides  Boolean                 @default(false)
  isActive       Boolean                 @default(true)
  defaultLayers  PhaseDefinitionLayer[]
  defaultChecks  PhaseDefinitionCheck[]
  phases         RoadPhase[]
  priceItems     PhaseItem[]
  workflows      PhaseWorkflowDefinition[]
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  @@unique([name, measure])
}

model LayerDefinition {
  id               Int                     @id @default(autoincrement())
  name             String                  @unique
  isActive         Boolean                 @default(true)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  definitionLinks  PhaseDefinitionLayer[]
  phaseLinks       RoadPhaseLayer[]
}

model CheckDefinition {
  id               Int                     @id @default(autoincrement())
  name             String                  @unique
  isActive         Boolean                 @default(true)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  definitionLinks  PhaseDefinitionCheck[]
  phaseLinks       RoadPhaseCheck[]
}

model PhaseDefinitionLayer {
  phaseDefinitionId Int
  layerDefinitionId Int
  phaseDefinition   PhaseDefinition @relation(fields: [phaseDefinitionId], references: [id], onDelete: Cascade)
  layerDefinition   LayerDefinition @relation(fields: [layerDefinitionId], references: [id], onDelete: Cascade)

  @@id([phaseDefinitionId, layerDefinitionId])
}

model PhaseDefinitionCheck {
  phaseDefinitionId Int
  checkDefinitionId Int
  phaseDefinition   PhaseDefinition @relation(fields: [phaseDefinitionId], references: [id], onDelete: Cascade)
  checkDefinition   CheckDefinition @relation(fields: [checkDefinitionId], references: [id], onDelete: Cascade)

  @@id([phaseDefinitionId, checkDefinitionId])
}

model PhaseWorkflowDefinition {
  id                Int             @id @default(autoincrement())
  phaseDefinitionId Int             @unique
  phaseDefinition   PhaseDefinition @relation(fields: [phaseDefinitionId], references: [id], onDelete: Cascade)
  config            Json
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model DailyReport {
  id         Int      @id @default(autoincrement())
  reportDate DateTime @unique
  payload    Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model LeaderDailyLog {
  id             Int      @id @default(autoincrement())
  logDate        DateTime
  supervisorId   Int
  supervisorName String
  contentRaw     String
  createdById    Int?
  updatedById    Int?
  createdBy      User?    @relation("LeaderDailyLogCreator", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy      User?    @relation("LeaderDailyLogUpdater", fields: [updatedById], references: [id], onDelete: SetNull)
  supervisor     User     @relation("LeaderDailyLogSupervisor", fields: [supervisorId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([logDate, supervisorId])
  @@index([logDate])
  @@index([supervisorId])
}

model RoadSection {
  id        Int      @id @default(autoincrement())
  projectId Int?
  slug      String   @unique
  name      String
  startPk   String
  endPk     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  phases    RoadPhase[]
  inspections InspectionRequest[]
  inspectionEntries InspectionEntry[]

  @@index([projectId])
}

model RoadPhase {
  id                Int                 @id @default(autoincrement())
  roadId            Int
  road              RoadSection         @relation(fields: [roadId], references: [id], onDelete: Cascade)
  phaseDefinitionId Int
  phaseDefinition   PhaseDefinition     @relation(fields: [phaseDefinitionId], references: [id])
  name              String
  measure           PhaseMeasure
  pointHasSides     Boolean             @default(false)
  designLength      Float               @default(0)
  intervals         PhaseInterval[]
  inspections       InspectionRequest[]
  entries           InspectionEntry[]
  layerLinks        RoadPhaseLayer[]
  checkLinks        RoadPhaseCheck[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model PhaseItem {
  id                Int                 @id @default(autoincrement())
  phaseDefinitionId Int
  phaseDefinition   PhaseDefinition     @relation(fields: [phaseDefinitionId], references: [id], onDelete: Cascade)
  name              String
  spec              String?
  measure           PhaseMeasure
  unitString        String?
  description       String?
  unitPrice         Decimal?            @db.Decimal(18, 2)
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  formula           PhaseItemFormula?
  boqLinks          PhaseItemBoqItem[]
  inputs            PhaseItemInput[]

  @@map("PhasePriceItem")
}

model PhaseItemFormula {
  id          Int       @id @default(autoincrement())
  phaseItemId Int       @unique
  phaseItem   PhaseItem @relation(fields: [phaseItemId], references: [id], onDelete: Cascade)
  expression  String
  inputSchema Json?
  unitString  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model PhaseItemBoqItem {
  id          Int       @id @default(autoincrement())
  phaseItemId Int
  boqItemId   Int
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  phaseItem PhaseItem @relation(fields: [phaseItemId], references: [id], onDelete: Cascade)
  boqItem   BoqItem   @relation(fields: [boqItemId], references: [id], onDelete: Cascade)

  @@unique([phaseItemId, boqItemId])
  @@index([boqItemId])
}

model PhaseItemInput {
  id               Int       @id @default(autoincrement())
  phaseItemId      Int
  intervalId       Int
  values           Json
  computedQuantity Decimal?  @db.Decimal(18, 4)
  manualQuantity   Decimal?  @db.Decimal(18, 4)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  phaseItem PhaseItem   @relation(fields: [phaseItemId], references: [id], onDelete: Cascade)
  interval  PhaseInterval @relation(fields: [intervalId], references: [id], onDelete: Cascade)

  @@unique([phaseItemId, intervalId])
  @@index([intervalId])
}

model PhaseInterval {
  id        Int           @id @default(autoincrement())
  phaseId   Int
  phase     RoadPhase     @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  startPk   Float
  endPk     Float
  side      IntervalSide
  spec      String?
  layers    String[]      @default([])
  layerIds  Int[]         @default([])
  billQuantity Float?
  phaseItemInputs PhaseItemInput[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model InspectionRequest {
  id         Int              @id @default(autoincrement())
  roadId     Int
  road       RoadSection      @relation(fields: [roadId], references: [id], onDelete: Cascade)
  phaseId    Int
  phase      RoadPhase        @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  side       IntervalSide
  startPk    Float
  endPk      Float
  layers     String[]
  checks     String[]
  types      String[]
  submissionOrder Int?
  remark     String?
  status     InspectionStatus @default(PENDING)
  appointmentDate DateTime?
  submittedAt     DateTime     @default(now())
  submittedBy     Int?
  submitter       User?        @relation("InspectionSubmitter", fields: [submittedBy], references: [id])
  createdBy       Int?
  creator         User?        @relation("InspectionCreator", fields: [createdBy], references: [id])
  updatedBy       Int?
  updater         User?        @relation("InspectionUpdater", fields: [updatedBy], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([phaseId, status, updatedAt])
}

model Document {
  id              Int                @id @default(autoincrement())
  code            String             @unique
  files           Json               @default("[]")
  remark          String?
  type            DocumentType       @default(SUBMISSION)
  templateId      String?
  template        DocumentTemplate? @relation(fields: [templateId], references: [id])
  templateVersion Int?
  status          DocumentStatus     @default(DRAFT)
  title           String?
  data            Json?
  createdById     Int?
  updatedById     Int?
  createdBy       User?              @relation("DocumentCreator", fields: [createdById], references: [id])
  updatedBy       User?              @relation("DocumentUpdater", fields: [updatedById], references: [id])
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  entries         InspectionEntry[]
  submission      Submission?
  letter          Letter?
  items           SubmissionItem[]

  @@index([type, status])
  @@index([createdAt])
  @@index([updatedAt])
}

model Letter {
  id           Int            @id @default(autoincrement())
  documentId   Int            @unique
  projectId    Int
  boqItemId    Int?
  letterNumber Int
  subject      String
  senderOrg    String?
  recipientOrg String?
  issuedAt     DateTime?
  receivedAt   DateTime?
  remark       String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  document     Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  project      Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  boqItem      BoqItem?       @relation(fields: [boqItemId], references: [id], onDelete: SetNull)

  @@unique([projectId, letterNumber])
  @@index([boqItemId])
}

model InspectionEntry {
  id           Int              @id @default(autoincrement())
  documentId   Int?
  document     Document?        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  roadId       Int
  road         RoadSection      @relation(fields: [roadId], references: [id], onDelete: Cascade)
  phaseId      Int
  phase        RoadPhase        @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  side         IntervalSide
  startPk      Float
  endPk        Float
  layerId      Int?
  layerName    String
  checkId      Int?
  checkName    String
  types        String[]
  status       InspectionStatus @default(PENDING)
  appointmentDate DateTime?
  remark       String?
  submissionOrder Int?
  submittedAt  DateTime         @default(now())
  submittedBy  Int?
  submitter    User?            @relation("InspectionEntrySubmitter", fields: [submittedBy], references: [id])
  createdBy    Int?
  creator      User?            @relation("InspectionEntryCreator", fields: [createdBy], references: [id])
  updatedBy    Int?
  updater      User?            @relation("InspectionEntryUpdater", fields: [updatedBy], references: [id])
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([roadId, phaseId, side, startPk, endPk, status])
  @@index([documentId])
}

model Submission {
  documentId         Int    @id
  submissionNumber   Int    @unique
  projectName        String
  projectCode        String
  contractNumbers    Json
  bordereauNumber    Int
  subject            String
  senderOrg          String
  senderDate         String
  senderLastName     String
  senderFirstName    String
  senderSignature    String?
  senderTime         String?
  recipientOrg       String
  recipientDate      String
  recipientLastName  String
  recipientFirstName String
  recipientSignature String?
  recipientTime      String?
  comments           String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

model SubmissionItem {
  id          Int      @id @default(autoincrement())
  documentId  Int
  order       Int?
  designation String
  quantity    Float?
  observation String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId, order])
}

model RoadPhaseLayer {
  roadPhaseId       Int
  layerDefinitionId Int
  roadPhase         RoadPhase     @relation(fields: [roadPhaseId], references: [id], onDelete: Cascade)
  layerDefinition   LayerDefinition @relation(fields: [layerDefinitionId], references: [id], onDelete: Cascade)

  @@id([roadPhaseId, layerDefinitionId])
}

model RoadPhaseCheck {
  roadPhaseId       Int
  checkDefinitionId Int
  roadPhase         RoadPhase      @relation(fields: [roadPhaseId], references: [id], onDelete: Cascade)
  checkDefinition   CheckDefinition @relation(fields: [checkDefinitionId], references: [id], onDelete: Cascade)

  @@id([roadPhaseId, checkDefinitionId])
}

model Permission {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  status    PermissionStatus @default(ACTIVE)
  roles     RolePermission[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id           Int              @id @default(autoincrement())
  name         String           @unique
  permissions  RolePermission[]
  users        UserRole[]
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

model User {
  id           Int        @id @default(autoincrement())
  name         String     @default("")
  gender       String?
  nationality  String?
  phones       String[]   @default([])
  tags         String[]   @default([])
  joinDate     DateTime?
  birthDate    DateTime?
  position     String?
  employmentStatus EmploymentStatus @default(ACTIVE)
  terminationDate DateTime?
  terminationReason String?
  username     String     @unique
  passwordHash String
  roles        UserRole[]
  submittedInspections InspectionRequest[] @relation("InspectionSubmitter")
  createdInspections  InspectionRequest[] @relation("InspectionCreator")
  updatedInspections  InspectionRequest[] @relation("InspectionUpdater")
  submittedInspectionEntries InspectionEntry[] @relation("InspectionEntrySubmitter")
  createdInspectionEntries  InspectionEntry[] @relation("InspectionEntryCreator")
  updatedInspectionEntries  InspectionEntry[] @relation("InspectionEntryUpdater")
  createdFinances FinanceEntry[] @relation("FinanceEntryCreator")
  deletedFinances FinanceEntry[] @relation("FinanceEntryDeleter")
  handledFinances FinanceEntry[] @relation("FinanceEntryHandler")
  updatedFinances FinanceEntry[] @relation("FinanceEntryUpdater")
  chineseProfile UserChineseProfile?
  expatProfile UserExpatProfile?
  expatSupervisees UserExpatProfile[] @relation("ExpatChineseSupervisor")
  teamSupervisorBindings TeamSupervisor[]
  supervisedLeaderDailyLogs LeaderDailyLog[] @relation("LeaderDailyLogSupervisor")
  createdLeaderDailyLogs LeaderDailyLog[] @relation("LeaderDailyLogCreator")
  updatedLeaderDailyLogs LeaderDailyLog[] @relation("LeaderDailyLogUpdater")
  contractChangeSupervisees UserContractChange[] @relation("ContractChangeSupervisor")
  payrollChangeSupervisees UserPayrollChange[] @relation("PayrollChangeSupervisor")
  payrollPayoutSupervisees UserPayrollPayout[] @relation("PayrollPayoutSupervisor")
  contractChanges UserContractChange[]
  payrollChanges UserPayrollChange[]
  payrollPayouts UserPayrollPayout[]
  projectAssignments UserProjectAssignment[]
  ownedFileAssets FileAsset[] @relation("FileAssetOwner")
  createdFileAssets FileAsset[] @relation("FileAssetCreator")
  createdFileLinks FileAssetLink[] @relation("FileAssetLinkCreator")
  signatures UserSignature[]
  createdSignatures UserSignature[] @relation("UserSignatureCreator")
  createdById  Int?
  updatedById  Int?
  createdBy    User?      @relation("UserCreator", fields: [createdById], references: [id])
  updatedBy    User?      @relation("UserUpdater", fields: [updatedById], references: [id])
  createdUsers User[]     @relation("UserCreator")
  updatedUsers User[]     @relation("UserUpdater")
  roadmapIdeasCreated RoadmapIdea[] @relation("RoadmapIdeaCreator")
  roadmapIdeasUpdated RoadmapIdea[] @relation("RoadmapIdeaUpdater")
  createdDocumentTemplates DocumentTemplate[] @relation("DocumentTemplateCreator")
  updatedDocumentTemplates DocumentTemplate[] @relation("DocumentTemplateUpdater")
  createdDocuments Document[] @relation("DocumentCreator")
  updatedDocuments Document[] @relation("DocumentUpdater")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model FileAsset {
  id           Int      @id @default(autoincrement())
  category     String
  storageKey   String   @unique
  bucket       String
  originalName String
  mimeType     String
  size         Int
  previewStorageKey String?
  previewMimeType   String?
  previewSize       Int?
  checksum     String?
  ownerUserId  Int?
  createdById  Int?
  ownerUser    User?    @relation("FileAssetOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  createdBy    User?    @relation("FileAssetCreator", fields: [createdById], references: [id], onDelete: SetNull)
  signatures   UserSignature[]
  links        FileAssetLink[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([ownerUserId])
}

model FileAssetLink {
  id          Int      @id @default(autoincrement())
  fileId      Int
  entityType  String
  entityId    String
  purpose     String?
  label       String?
  meta        Json?
  createdById Int?
  file        FileAsset @relation(fields: [fileId], references: [id], onDelete: Cascade)
  createdBy   User?    @relation("FileAssetLinkCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())

  @@index([fileId])
  @@index([entityType, entityId])
  @@index([purpose])
}

model UserSignature {
  id          Int      @id @default(autoincrement())
  userId      Int
  fileId      Int
  version     Int
  isActive    Boolean  @default(false)
  createdById Int?
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  file        FileAsset @relation(fields: [fileId], references: [id], onDelete: Cascade)
  createdBy   User?    @relation("UserSignatureCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())

  @@unique([userId, version])
  @@index([userId])
  @@index([fileId])
}

model RolePermission {
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId Int
  roleId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model UserChineseProfile {
  userId                 Int     @id
  user                   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  frenchName             String?
  idNumber               String?
  passportNumber         String?
  educationAndMajor      String?
  certifications         String[] @default([])
  domesticMobile         String?
  emergencyContactName   String?
  emergencyContactPhone  String?
  redBookValidYears      Int?    @default(0)
  cumulativeAbroadYears  Int?    @default(0)
  birthplace             String?
  residenceInChina       String?
  medicalHistory         String?
  healthStatus           String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model UserExpatProfile {
  userId             Int          @id
  user               User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  chineseSupervisorId Int?
  chineseSupervisor  User?        @relation("ExpatChineseSupervisor", fields: [chineseSupervisorId], references: [id], onDelete: SetNull)
  team               String?
  contractNumber     String?      @unique
  contractType       ContractType?
  contractStartDate  DateTime?
  contractEndDate    DateTime?
  salaryCategory     String?
  prime              Decimal?     @db.Decimal(18, 2)
  baseSalaryAmount   Decimal?     @db.Decimal(18, 2)
  baseSalaryUnit     SalaryUnit?
  netMonthlyAmount   Decimal?     @db.Decimal(18, 2)
  netMonthlyUnit     SalaryUnit?
  maritalStatus      String?
  childrenCount      Int?
  cnpsNumber         String?
  cnpsDeclarationCode String?
  provenance         String?
  emergencyContactName String?
  emergencyContactPhone String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
}

model TeamSupervisor {
  id              Int      @id @default(autoincrement())
  team            String
  teamZh          String?
  teamKey         String   @unique
  supervisorId    Int
  projectId       Int?
  supervisor      User     @relation(fields: [supervisorId], references: [id], onDelete: Cascade)
  project         Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  supervisorName  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([team])
  @@index([supervisorId])
  @@index([projectId])
}

model UserProjectAssignment {
  id        Int      @id @default(autoincrement())
  userId    Int
  projectId Int
  startDate DateTime
  endDate   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([endDate])
}

model UserContractChange {
  id                   Int          @id @default(autoincrement())
  userId               Int
  user                 User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  team                 String?
  chineseSupervisorId  Int?
  chineseSupervisor    User?        @relation("ContractChangeSupervisor", fields: [chineseSupervisorId], references: [id], onDelete: SetNull)
  chineseSupervisorName String?
  position             String?
  contractNumber       String?
  contractType         ContractType?
  salaryCategory       String?
  salaryAmount         Decimal?     @db.Decimal(18, 2)
  salaryUnit           SalaryUnit?
  prime                Decimal?     @db.Decimal(18, 2)
  startDate            DateTime?
  endDate              DateTime?
  changeDate           DateTime     @default(now())
  reason               String?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([userId])
  @@index([changeDate])
}

model UserPayrollChange {
  id                   Int          @id @default(autoincrement())
  userId               Int
  user                 User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  team                 String?
  chineseSupervisorId  Int?
  chineseSupervisor    User?        @relation("PayrollChangeSupervisor", fields: [chineseSupervisorId], references: [id], onDelete: SetNull)
  chineseSupervisorName String?
  salaryCategory       String?
  salaryAmount         Decimal?     @db.Decimal(18, 2)
  salaryUnit           SalaryUnit?
  prime                Decimal?     @db.Decimal(18, 2)
  baseSalaryAmount     Decimal?     @db.Decimal(18, 2)
  baseSalaryUnit       SalaryUnit?
  netMonthlyAmount     Decimal?     @db.Decimal(18, 2)
  netMonthlyUnit       SalaryUnit?
  changeDate           DateTime     @default(now())
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([userId])
  @@index([changeDate])
}

model PayrollRun {
  id         Int       @id @default(autoincrement())
  year       Int
  month      Int
  sequence   Int
  payoutDate DateTime
  attendanceCutoffDate DateTime
  note       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  payouts    UserPayrollPayout[]

  @@unique([year, month, sequence])
  @@index([year, month])
  @@index([payoutDate])
}

model UserPayrollPayout {
  id                   Int          @id @default(autoincrement())
  userId               Int
  user                 User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  runId                Int
  run                  PayrollRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  team                 String?
  chineseSupervisorId  Int?
  chineseSupervisor    User?        @relation("PayrollPayoutSupervisor", fields: [chineseSupervisorId], references: [id], onDelete: SetNull)
  chineseSupervisorName String?
  payoutDate           DateTime
  amount               Decimal      @db.Decimal(18, 2)
  currency             String       @default("XOF")
  note                 String?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([userId])
  @@index([runId])
  @@index([payoutDate])
  @@unique([runId, userId])
}

model Project {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  code      String?   @unique
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  finances  FinanceEntry[]
  teamSupervisors TeamSupervisor[]
  memberAssignments UserProjectAssignment[]
  boqItems BoqItem[]
  boqMeasurements BoqMeasurement[]
  letters   Letter[]
  roadSections RoadSection[]
}

model BoqItem {
  id             Int          @id @default(autoincrement())
  projectId      Int
  sheetType      BoqSheetType @default(CONTRACT)
  contractItemId Int?
  code           String
  designationZh  String
  designationFr  String
  unit           String?
  unitPrice      Decimal?     @db.Decimal(18, 2)
  quantity       Decimal?     @db.Decimal(18, 2)
  totalPrice     Decimal?     @db.Decimal(18, 2)
  tone           BoqItemTone  @default(ITEM)
  sortOrder      Int          @default(0)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  project        Project      @relation(fields: [projectId], references: [id])
  contractItem   BoqItem?     @relation("BoqItemContractLink", fields: [contractItemId], references: [id])
  derivedItems   BoqItem[]    @relation("BoqItemContractLink")
  measurements   BoqMeasurement[]
  phaseItemLinks PhaseItemBoqItem[]
  letters        Letter[]

  @@index([projectId, sheetType, sortOrder])
  @@index([projectId, sheetType, code])
}

model BoqMeasurement {
  id        Int       @id @default(autoincrement())
  projectId Int
  boqItemId Int
  period    DateTime
  quantity  Decimal   @db.Decimal(18, 2)
  unitPrice Decimal?  @db.Decimal(18, 2)
  amount    Decimal?  @db.Decimal(18, 2)
  note      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id])
  boqItem BoqItem @relation(fields: [boqItemId], references: [id], onDelete: Cascade)

  @@unique([boqItemId, period])
  @@index([projectId, period])
}

model FinanceUnit {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  symbol    String?
  isActive  Boolean   @default(true)
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  finances  FinanceEntry[]
}

model PaymentType {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  isActive  Boolean   @default(true)
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  finances  FinanceEntry[]
}

model FinanceCategory {
  key       String   @id
  parentKey String?
  labelZh   String
  labelEn   String?
  labelFr   String?
  code      String?
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  children  FinanceCategory[] @relation("FinanceCategoryToFinanceCategory")
  parent    FinanceCategory?  @relation("FinanceCategoryToFinanceCategory", fields: [parentKey], references: [key])
  finances  FinanceEntry[]
}

model FinanceEntry {
  id            Int            @id @default(autoincrement())
  sequence      Int            @default(autoincrement())
  projectId     Int
  reason        String
  categoryKey   String
  parentKeys    String[]       @default([])
  amount        Decimal        @db.Decimal(18, 2)
  unitId        Int
  paymentTypeId Int
  paymentDate   DateTime
  paymentStatus PaymentStatus @default(PAID)
  tva           Decimal?       @db.Decimal(18, 2)
  remark        String?
  handlerId     Int?
  isDeleted     Boolean        @default(false)
  deletedAt     DateTime?
  deletedBy     Int?
  updatedBy     Int?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     Int?
  project       Project        @relation(fields: [projectId], references: [id])
  category      FinanceCategory @relation(fields: [categoryKey], references: [key])
  unit          FinanceUnit    @relation(fields: [unitId], references: [id])
  paymentType   PaymentType    @relation(fields: [paymentTypeId], references: [id])
  creator       User?          @relation("FinanceEntryCreator", fields: [createdBy], references: [id])
  updater       User?          @relation("FinanceEntryUpdater", fields: [updatedBy], references: [id])
  deleter       User?          @relation("FinanceEntryDeleter", fields: [deletedBy], references: [id])
  handler       User?          @relation("FinanceEntryHandler", fields: [handlerId], references: [id])

  @@unique([sequence])
  @@index([projectId])
  @@index([categoryKey])
  @@index([paymentDate])
  @@index([isDeleted])
  @@index([handlerId])
  @@index([paymentStatus])
}

model DocumentTemplate {
  id           String         @id @default(cuid())
  name         String
  type         DocumentType   @default(SUBMISSION)
  version      Int            @default(1)
  status       TemplateStatus @default(DRAFT)
  language     String         @default("fr")
  html         String         @db.Text
  placeholders Json
  createdById  Int?
  updatedById  Int?
  createdBy    User?          @relation("DocumentTemplateCreator", fields: [createdById], references: [id])
  updatedBy    User?          @relation("DocumentTemplateUpdater", fields: [updatedById], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  documents    Document[]

  @@index([type, status])
  @@index([name])
}

model RoadmapIdea {
  id           Int            @id @default(autoincrement())
  title        String
  details      String?
  priority     Int            @default(3)
  importance   Int            @default(3)
  difficulty   Int            @default(3)
  status       RoadmapStatus  @default(PENDING)
  completedAt  DateTime?
  createdById  Int?
  updatedById  Int?
  createdBy    User?          @relation("RoadmapIdeaCreator", fields: [createdById], references: [id])
  updatedBy    User?          @relation("RoadmapIdeaUpdater", fields: [updatedById], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([status, createdAt])
}
